\documentclass[11pt,a4paper]{article}

\setlength{\topmargin}{0cm}
\setlength{\headheight}{0.4cm}
\setlength{\headsep}{0.8cm}
\setlength{\footskip}{1cm}
\setlength{\textwidth}{17cm}
\setlength{\textheight}{25cm}
\setlength{\voffset}{-1.5cm}
\setlength{\hoffset}{-0.5cm}
\setlength{\oddsidemargin}{0cm}
\setlength{\evensidemargin}{0cm}
\setlength{\parskip}{6pt}



\usepackage[latin1]{inputenc}
\usepackage[cyr]{aeguill}
\usepackage[francais]{babel}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{amssymb} %symboles math
\usepackage{amsfonts} %symboles math 
\usepackage{enumitem}
\usepackage{tikz} 
\usepackage{float}
\usepackage{braket}
\usepackage{fancyvrb}
\usepackage{minted}
\usepackage{graphicx} 
\usepackage{fancyhdr} 
\usepackage{epstopdf} 
\usepackage[squaren,Gray]{SIunits}
\usepackage{tabularx} % gestion avancée des tableaux
\usepackage{url}
\usepackage{hyperref}
\usepackage{bbold}
\usepackage[format=hang]{caption}
\usepackage{subcaption}
\usepackage{stmaryrd} 
\usepackage{placeins} 
\usepackage{caption}


\pagestyle{fancy}
\fancyhead[L]{\scriptsize \textsc{Une méthode de calibration non paramétrique pour les calorimètres de CMS}}
\fancyhead[R]{\scriptsize \textsc{Samuel Niang}} 
\fancyfoot[C]{ \thepage}

% commande de déplacement d'un objet
\newcommand{\drawat}[3]{\makebox[0pt][l]{\raisebox{#2}{\hspace*{#1}#3}}}

\usepackage[printwatermark]{xwatermark}

  
\begin{document}

% Pour faciliter la mise en forme de la page du titre, on supprime l'indentation automatique en début de paragraphe
\setlength{\parindent}{0pt}

\thispagestyle{empty}

\includegraphics[height=2cm]{images/logoens.eps} \hfill \includegraphics[height=2cm]{images/logoucbl.eps} \hfill \includegraphics[height=2cm]{images/logounivlyon.png}

\vspace{1cm}

\begin{tabularx}{\textwidth}{@{} l X l @{} }
{\sc Master Science de la matière} & & Rapport de stage\\
{\it \'{E}cole Normale Supérieure de Lyon} & & Samuel Niang\\
{\it Université Claude Bernard Lyon I} & & M2 Physique - Concepts et applications

\end{tabularx}


\begin{center}

\vspace{1cm}

\rule[11pt]{5cm}{0.5pt}

\textbf{\huge Une méthode de calibration non paramétrique pour les calorimètres de CMS.}

\rule{5cm}{0.5pt}

\vspace{2cm}

\parbox{15cm}{\small
\textbf{Résumé} : \\
\rm Avec le détecteur CMS, l'énergie des hadrons neutres est déterminée à partir de l'énergie mesurée dans les calorimètres électromagnétiques ($E_{\rm ecal}$) et hadroniques ($E_{\rm hcal}$). Une calibration est cependant nécessaire pour estimer l'énergie vraie du hadron neutre à partir de $E_{\rm ecal}$ et $E_{\rm hcal}$. Dans un premier temps, j'ai utilisé comme calibration une fonction linéaire de $E_{\rm ecal}$ et $E_{\rm hcal}$. Ensuite, afin de décrire la non linéarité de la mesure de l'énergie, j'ai inventé une nouvelle méthode de calibration non paramétrique.
}

\vspace{1cm}
\begin{center}
\includegraphics[height=2cm]{images/Logo_IPNL.jpg} 
\hspace{1cm}
\includegraphics[height=2cm]{images/Logo_CMS.png} 
\hspace{1cm}
\includegraphics[height=2cm]{images/cern_logo.png} 
\end{center}
\vspace{1cm}

\parbox{15cm}{
\textbf{Mots clefs} : \it Calibration, Modélisation, Physique des particules
} 

\vspace{0.5cm}

\parbox{15cm}{
Stage encadré par :

{\bf Colin Bernet}
\href{mailto:colin.bernet@cern.ch}{\tt colin.bernet@cern.ch} 

%Nom du Laboratoire d'accueil

{\it Bâtiment Paul Dirac\\
4, Rue Enrico Fermi\\
69622 Villeurbanne Cedex\\
Tél. : +33 (0) 4 72 44 84 57}

} %fin de la commande \parbox encadrant / laboratoire d'accueil

\vspace{0.5cm}

\end{center}
\vfill
\hfill \today

\newpage
\thispagestyle{empty}
\tableofcontents
\setcounter{page}{1}

\setlength{\parindent}{16pt}





\newpage
\section{Introduction}
Après avoir permis la découverte expérimentale du boson de Higgs en 2012 \cite{HiggsATLAS,HiggsCMS}, les expériences généralistes ATLAS et CMS installées sur le LHC du CERN sont toujours en place dans l'optique de découvrir de la nouvelle physique au-delà du modèle standard.

Les détecteurs ATLAS et CMS sont basés sur les mêmes principes : cylindriques, ils sont constitués d'un ensemble de sous-détecteurs disposés en couches concentriques autour du point d'interaction. Les informations provenant de ces sous-détecteurs sont combinées pour déterminer le type, l'énergie et la direction des particules de l'état final de la collision afin d'en mesurer les propriétés, et par exemple déterminer si une particule instable encore inconnue a été produite. 

Nous allons nous intéresser plus spécifiquement au détecteur CMS \cite{CMS}. Celui-ci dispose  :
\begin{itemize}
\item d'un champ magnétique, pour courber la trajectoire des particules chargées;
\item d'un trajectographe, pour reconstruire la trajectoire des particules chargées, et ainsi obtenir la charge et l'impulsion à partir de la courbure de la trajectoire dans le champ magnétique; 
\item d'un calorimètre électromagnétique (ECAL) \cite{ECAL} constitué d'un cristal de tungstate de plomb, permettant de collecter les dépôts d'énergie des particules, principalement électrons et photons, mais aussi hadrons chargés et neutres;
\item d'un calorimètre hadronique (HCAL) \cite{HCAL} composé de plusieurs couches d'absorbeur en laiton et de carreaux scintillateurs en plastique, avec une segmentation grossière. Le HCAL permet la mesure de l'énergie $E$ d'un hadron avec une résolution de l'ordre de $100\%\sqrt{(E / \SIUnits{}{\giga\electronvolt})}$;
\item de chambres à muons qui permettent l'identification de ces particules, les seules à pouvoir y parvenir.
\end{itemize}

La Figure \ref{detecteur} illustre le comportement des particules dans les différentes couches du détecteur:
\begin{enumerate}
    \item photons :
    	\begin{itemize}
		\item déposent leur énergie dans ECAL;
	\end{itemize}
    \item $e^+,e^-$ :
        \begin{itemize}
        		\item produisent une trace dans le trajectographe;
		\item déposent leur énergie dans ECAL;
        \end{itemize}
    \item hadrons chargés :
        \begin{itemize}
        		\item produisent une trace dans le trajectographe;
    		\item peuvent démarrer une gerbe hadronique dans ECAL et y déposer une partie de leur énergie;
    		\item déposent le reste de leur énergie dans le HCAL;
		\item finissent leur course dans le HCAL;
        \end{itemize}
    \item hadrons neutres :
        \begin{itemize}
        		\item peuvent démarrer une gerbe hadronique dans ECAL et y déposer une partie de leur énergie;
    		\item déposent le reste de leur énergie dans le HCAL;
		\item finissent leur course dans le HCAL;
        \end{itemize}
    \item $\mu^+,\mu^-$ :
        \begin{itemize}
        		\item produisent une trace dans le trajectographe;
		\item traversent le ECAL et le HCAL comme des particules au minimum d'ionisation;
		\item sont détectées dans la chambre à muons.
        \end{itemize}
\end{enumerate}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=0.7\textwidth]{images/detecteur.pdf}
\caption{Une esquisse des interactions spécifiques des particules dans une tranche transversale du détecteur CMS.}
\label{detecteur}
\end{center}
\end{figure}
\`A noter que dans notre étude, seuls les hadrons neutres nous intéressent. \\

La connaissance des dépôts d'énergie et du comportement des particules dans les différentes parties du détecteur nous permettent de reconnaître et distinguer les particules : cette opération s'appelle le \textit{Particle Flow (PF)}. Cependant, il est aussi nécessaire d'estimer l'énergie des particules ($E_{\rm true})$ à l'aide d'une calibration des calorimètres. En effet, ces derniers ne présentent pas une réponse linéaire et la somme des énergies dans les calorimètres ne correspond pas à l'énergie de la particule. Cette énergie de calibration sera notée $E_{\rm calib}$.

Pour effectuer la calibration nous allons utiliser des particules simulées. La production de ces données sera explicitée dans la section \ref{echantillon}.

En première approximation, nous déterminerons l'énergie calibrée par une fonction linéaire de l'énergie lue dans le ECAL (énergie notée par la suite $E_{\rm ecal}$) et de celle lue dans le HCAL (notée par la suite $E_{\rm hcal}$). Cette méthode sera présentée dans la section \ref{LR}.

Ce rapport présente ensuite de nouvelles techniques de calibration qui permettent de prendre en compte la non-linéarité des calorimètres. Ces techniques seront présentées dans les sections \ref{CL} et \ref{KNN}.\\
Enfin, nous comparerons ces méthodes dans la section \ref{comparaison}. 

\section{Production de l'échantillon}
\label{echantillon}

La calibration des calorimètres est réalisée grâce à un échantillon de pions chargés. Chaque événement contient un unique hadron chargé d'énergie comprise entre 0 et 200 GeV, et de pseudo-rapidité inférieure à 0.5. La calibration n'est pour l'instant pas réalisée pour des particules d'énergie supérieure, ou émises vers l'avant. 
Chaque hadron est traité par la simulation complète de CMS, dans laquelle les interactions avec les détecteurs sont modélisées par GEANT4 \cite{GEANT4}. Les dépôts d'énergie calorimétriques sont reconstruits par l'algorithme de reconstruction standard de CMS.

Les données simulées sont stockées dans un fichier \textit{.root}. Par souci de compatibilité, j'ai voulu écarter \textit{Root}, qui est à la fois un programme et une librairie C++ pour tout faire en Python.  J'ai donc écrit un programme \cite{RootToPhython} pour extraire les données du fichier initial pour les déplacer dans un nouveau fichier binaire importable facilement par Python et qui contient, pour chaque hadron simulé : son énergie réelle ($E_{\rm true}$), son impulsion, l'énergie déposée dans le ECAL ($E_{\rm ecal}$), l'énergie déposée dans le HCAL ($E_{\rm hcal}$), sa pseudo-rapidité.

On séparera et traitera différemment les événements qui ont $E_{\rm ecal} = 0$ de ceux avec $E_{\rm ecal} \neq 0$ (Figure \ref{points}).  Ces événements sont liés à des particules qui ont interagi avec le détecteur hadronique mais pas avec le détecteur électromagnétique (\textit{cf.} Figure\ref{detecteur}). Cette séparation se justifie, car modéliser les dépôts d'énergie dans les deux calorimètres pour en conclure ce qui se passe dans le cas particulier où il n'y a de dépôt que dans l'un d'eux amène un biais. Ainsi, à chaque construction de calibration, on créera en fait deux modèles.

\begin{figure}[!h]
\begin{center}
\includegraphics[width=0.45\linewidth]{images/pictures/testLinearRegression/LinearRegression_plot3D_training.png}
\includegraphics[width=0.45\linewidth]{images/pictures/explain/ecal_eq_0.png}
\caption{A gauche, l'énergie vraie $E_{\rm true}$ en fonction de l'énergie mesurée dans le ECAL, $E_{\rm ecal} \neq 0$, et de l'énergie mesurée dans le HCAL, $E_{\rm hcal}$, pour un échantillon d'événements ou un seul hadron est simulé dans le détecteur. À droite, idem mais avec avec $E_{\rm ecal} = 0$. Ces deux nuages de points seront modélisés séparément.}
\label{points}
\end{center}
\end{figure}

De plus, la simulation crée un palier car les particules sont limitées à $E_{\rm true} = \SIUnits{200}{\giga\electronvolt}$. Si l'on regarde par exemple sur la Figure \ref{limite} ce qui se passe dans le plan $E_{\rm ecal} = 0$, on voit bien ce palier qui apparaît vers $\SIUnits{150}{\giga\electronvolt}$, il est donc ici impossible de déduire une énergie de calibration à partir des points au-delà de cette limite. Avec ce jeu de données, nous allons fixer une limite $E_{\rm ecal} + E_{\rm hcal}  = (\rm{lim} = \SIUnits{150}{\giga\electronvolt})$.

La Figure \ref{limite} montre en particulier que dans le plan $E_{\rm ecal} = 0$, la limite fixée nous évite bien le palier (en vert sur la figure), de plus pour se convaincre que cette limite est acceptable, il est présenté en bas à droite de la Figure \ref{limite} les points qui se trouvent proches du plan tourné de $\theta = \pi/4$, en effet, nous pouvons constater que le palier est aussi évité avec cette limite à $\SIUnits{150}{\giga\electronvolt}$.

Dans le programme développé, la limitation se manifeste ainsi : si l'on tente de prédire une énergie calibrée dans la zone $E_{\rm ecal} + E_{\rm hcal}  > (\rm{lim} = \SIUnits{150}{\giga\electronvolt})$, le programme nous retournera $E_{\rm ecal} = \rm{\textit{math.nan}}$ (not a number), pour nous indiquer qu'il est impossible de retourner une valeur.

Pour construire la calibration nous utiliserons un premier jeu de données dit d'entrainement, c'est à dire un ensemble de points ($E_{\rm ecal},E_{\rm hcal},E_{\rm true})$ obtenus par simulation d'interactions de pions chargés avec les calorimètres comme expliqué en début de section. L'efficacité d'une calibration sera évaluée avec un second jeu de données pour éviter un biais. On comparera alors l'énergie calibrée d'une particule $E_{\rm calib}$ à sa vraie énergie $E_{\rm true}$. 

\begin{figure}[!h]
    \begin{center}
        \includegraphics[width=0.75\textwidth]{images/pictures/explain/limit.png}
        \caption{On place une limite à $E_{\rm ecal}+E_{\rm hcal} = \SIUnits{150}{\giga\electronvolt}$. À gauche : en bleu la zone où nous pouvons calculer les énergies calibrée, en vert, là où nous ne le pouvons pas. En haut à droite : idem mais pour les points qui ont $E_{\rm ecal} = 0$. En bas à droit : idem mais pour les points dans le cône.}
        \label{limite}
    \end{center}
\end{figure}



\section{Calibration par régression linéaire}
\label{LR}

Comme première calibration, j'ai utilisé une méthode simple, la régression linéaire. Il s'agit de supposer qu'il existe une relation 
\begin{equation}
    E_{\rm calib} = a_1 E_{\rm ecal} + a_2 E_{\rm hcal} + b
\end{equation}
et de trouver les coefficients $a_1, a_2,  b$ optimaux pour que le modèle coïncide au mieux aux données d'entrainement. L'ajustement est réalisé par la méthode des moindres carrés, grâce à la librairie \textit{Scikit Learn}  \cite{scikitLR}. Dans notre cas, cela revient à trouver les coefficients qui, pour un ensemble de données d'entraînement  composé de $N$ points $(E_{\rm ecal}^n,E_{\rm hcal}^n, E_{\rm true}^n), n \in \{1,...,N\}$ minimiseront :
\begin{equation}
	\epsilon = \sum_{n=1}^N  \left(E_{\rm true} - a_1 E_{\rm ecal} - a_2 E_{\rm hcal} - b \right)^2
\end{equation}

J'ai constaté qu'à faible $E_{\rm ecal}, E_{\rm hcal}$ il y a quelques points à très haut $E_{\rm true}$ qui correspondent à des défauts de la détection des énergies dans les calorimètres, je les ai donc enlevés des données d'entraînement pour la regression linéaire (\textit{cf.} Figure \ref{selectedpoints}). J'ai également enlevé les points à haut $E_{\rm ecal},  E_{\rm hcal}$ pour les raisons expliquées dans la section précédente.

\begin{figure}[!h]
    \begin{center}
        \includegraphics[width=0.75\textwidth]{images/pictures/testLinearRegression/LinearRegression_selectedpoints.png}
        \caption{\'Energie vraie en fonction de l'énergie déposée dans le HCAL, pour l'échantillon de hadrons n'interagissant pas dans le ECAL. Les points en bleu sont ceux qui sont conservés pour la régression linéaire. }
        \label{selectedpoints}
    \end{center}
\end{figure}

\notindent
\begin{minipage}{0.55\linewidth}
 Nous pouvons à présent effectuer la regression linéaire \cite{GitHubLR} sur un premier jeu de données d'entrainement en ne prenant en compte dans la régression que les points tels que $ $\rm{E_{\rm min}} < E_{\rm ecal} + E_{\rm hcal} < \rm{E_{\rm max}}$, avec $\rm{E_{\rm min}} = \SIUnits{150}{\giga\electronvolt}, \rm{E_{\rm min}} = \SIUnits{150}{\giga\electronvolt}$. Nous obtenons alors (\textit{cf.} Figure \ref{surfaceLR}, Figure \ref{courbeLR}):
    \[
    \begin{cases}
     E_{\rm ecal} = 0 : \\
    E_{\rm calib} =  0.95359395 E_{\rm hcal}  + 5.9057809  \\
    E_{\rm ecal} \neq 0 :\\
    E_{\rm calib} = 0.9876819  E_{\rm hcal}   + 1.3081561  E_{\rm ecal} + 8.5016036
    \end{cases}
	\]
\end{minipage}
\begin{minipage}{0.45\linewidth}
	\includegraphics[width = \textwidth]{images/pictures/testLinearRegression/LinearRegression_plot3D_surf.eps}
	\captionof{figure}{Le nuage de point de la Figure \ref{points} a été modélisée par une surface : $E_{\rm calib} = f(E_{\rm ecal},E_{\rm hcal})$}
	\label{surfaceLR}
\end{minipage}

La Figure \ref{courbeLR} montre que en particulier que dans le cas  $E_{\rm ecal} = 0$, la courbe ne passe pas par le le coeur du nuage de point à faible $E_{\rm hcal}$. 

\begin{figure}[!h]
\begin{center}
\includegraphics[height =5cm]{images/pictures/testLinearRegression/LinearRegression_calibration.png}
\caption{En bleu : \'Energie vraie en fonction de l'énergie déposée dans le HCAL, pour l'échantillon de hadrons n'interagissant pas dans le ECAL. En vert : courbe de calibration $E_{\rm calib} = f(E_{\rm hcal})$. La figure de droite est un zoom proche de l'origine de la figure de gauche.}
\label{courbeLR}
\end{center}
\end{figure}

On teste maintenant l'efficacité de la calibration sur un second jeu de données en affichant $E_{\rm calib}/$E_{\rm true}$ pour ce nouveau jeu de données. $E_{\rm calib}/$E_{\rm true}$ doit être le plus proche possible de 1.

La Figure \ref{LR_ecaliboveretrue_ecal_hcal} montre que la régression linéaire est mauvaise à faible $E_{\rm hcal}$ car en moyenne, $E_{\rm calib}/E_{\rm true}$ n'est pas proche de $1$. Plus intéressant, la figure de droite met en avant les non-linéarités du nuage de point : en effet il y a clairement une zone limitée où le modèle linéaire semble fonctionner, mais partout ailleurs, les points sont éloignés du plan.  

La Figure \ref{LR_ecaliboveretrue_etrue} montre que la calibration n'est pas bonne : $E_{\rm calib}/E_{\rm true}$  est trop écarté de 1, à part autour de $E_{\rm true} = \SIUnits{100}{\giga\electronvolt}$. Nous constatons que à haute énergie, la distribution dessine une asymptote. Cela est en fait un artefact lié à la simulation car les particules sont limitées à $E_{\rm true} = \SIUnits{200}{\giga\electronvolt}$, donc nous ne retrouvons pas des points de part et d'autre de la ligne $E_{\rm calib}/E_{\rm true} = 1$. On ne peut donc rien déduire de la courbe verte qui tente de suivre la distribution à haute énergie ($\approx \SIUnits{150}{\giga\electronvolt}$). Cela est valable pour toutes les figures qui présenteront E_{\rm calib}/E_{\rm true}$ en fonction de $E_{\rm true}$.

\begin{figure}[!h]
\begin{center}
\includegraphics[height =4.5cm]{images/pictures/testLinearRegression/LinearRegression_ecalib_over_etrue_functionof_ecal_hcal.png}
\caption{À gauche : en bleu $E_{\rm calib}/E_{\rm true}$ en fonction de $E_{\rm hcal}$ pour les particules n'interagissant pas avec le ECAL, chaque point de la courbe verte correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches de l'abscisse correspondante.
À droite : chaque pixel correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches des coordonnées du pixel pour les particules qui interagissent avec le ECAL et le HCAL.}
\label{LR_ecaliboveretrue_ecal_hcal}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[height =4.5cm]{images/pictures/testLinearRegression/LinearRegression_ecalib_over_etrue.png}
\caption{À gauche : en bleu la distribution en fonction des $E_{\rm true}$ des $E_{\rm calib}/E_{\rm true}$ pour les particules n'interagissant pas avec le ECAL, chaque point de la courbe verte correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches de l'abscisse correspondante. À droite : idem pour les particules qui interagissent avec le ECAL et le HCAL.}
\label{LR_ecaliboveretrue_etrue}
\end{center}
\end{figure}

Il faut à présent proposer une méthode qui prend en compte la non-linéarité entre les 3 variables. 











\section{Méthode non paramétrique binée}
\label{CL}
Ici, l'idée est de découper le plan $(E_{\rm ecal},E_{\rm hcal})$ en bins et de calculer la moyenne des $E_{\rm true}$ dans chaque bin qui sera la valeur $E_{\rm calib}$. 

Ainsi pour prédire une énergie de $E_{\rm calib}^i$ pour un point $(E_{\rm ecal}^i,E_{\rm hcal}^i)$, nous allons regarder dans quel bin il se trouve et retourner la valeur d'énergie calibrée correspondante. Nous pouvons voir sur la Figure \ref{legos} une illustration où la hauteur de chaque brique correspond à l'énergie calibrée d'un bin.

L'avantage de cette calibration est de prendre en compte ce qui se passe localement dans la distribution contrairement à la régression linéaire, mais elle a pour désavantage d'avoir un paramètre arbitraire qui influe sur la calibration, la taille des bins :  un pas trop grand fait perdre en précision car un grand nombre de particules se retrouvent avec la même énergie de calibration, un pas trop petit laisse des trous dans la position des briques (\textit{cf.} Figure \ref{legos}) ce qui donne des bins vides et une impossibilité de prédire une énergie de calibration. De plus, un grand nombre de bins fait exploser le temps de calcul. 

\begin{figure}[!h]
\begin{center}
	\includegraphics[width=0.5\linewidth]{images/pictures/testCalibrationLego/CalibrationLego_plot3D_legos.eps}
	\caption{Illustration de la calibration avec $100\times100$ bins. La hauteur d'une brique correspond à l'énergie de calibration du bin.}
	\label{legos}
\end{center}
\end{figure}

\noindent
\begin{minipage}{0.5\linewidth}
La calibration \cite{GitHubCL} est construite à l'aide d'un premier jeu de données, avec $100\times100$ bins. Premièrement, nous constatons que la surface n'est pas lisse, $E_{\rm calib}$ fluctue fortement, et si nous regardons ce qui se passe dans le plan $E_{\rm ecal} = 0$ (Figure \ref{calibCL}), nous voyons que cette méthode binée donne des énergies calibrées $E_{\rm calib}$ égales pour des ensembles de points, par paliers. Deuxièmement, nous constatons une fois de plus que la courbe de calibration ne passe pas par le coeur de la distribution à bas $E_{\rm hcal}$ : $E_{\rm calib}$ y est sur-évaluée.
\end{minipage}
\begin{minipage}{0.5\linewidth}
	\centering
	\includegraphics[width=0.7\textwidth]{images/pictures/testCalibrationLego/CalibrationLego_plot3D_surf.eps}
	\captionof{figure}{Surface de calibration $E_{\rm calib}$  en fonction de $E_{\rm ecal}$ et $E_{\rm hcal}$ , avec $100\times100$ bins.}
	\label{surfaceCL}
\end{minipage}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=\textwidth]{images/pictures/testCalibrationLego/CalibrationLego_calibration.png}
\caption{En bleu : \'Energie vraie en fonction de l'énergie déposée dans le HCAL, pour l'échantillon de hadrons n'interagissant pas dans le ECAL. En vert : courbe de calibration $E_{\rm calib} = f(E_{\rm hcal})$. La figure de droite est un zoom proche de l'origine de la figure de gauche.}
\label{calibCL}
\end{center}
\end{figure}

Il est alors possible de calculer l'énergie de calibration pour un second jeu de données. Nous remarquons que la présence de paliers dans la courbe de calibration biaise la calibration en faisant apparaître une structure (des hyperboles) dans $E_{\rm calib}/E_{\rm true}$, comme nous pouvons le voir dans la Figure \ref{ecaliboveretrueCL}. Cette structure est liée aux points possédant la même énergie de calibration, contrairement au cas de la régression linéaire (\textit{cf.} Figure  \ref{LR_ecaliboveretrue_etrue}). 
Nous constatons également sur la Figure \ref{ecaliboveretrueCL} que $E_{\rm calib}/E_{\rm true}$ est en moyenne constamment $> 1$, ce qui montre qu'il y a une tendance à la sur-évaluation de $E_{\rm calib}$.

La Figure \ref{ecaliboveretrueCL_etrue} nous montre une fois de plus que $E_{\rm calib}/E_{\rm true}$  est globalement sur-évaluée, mais que cette fois-ci, nous avons pris en compte les non-linéarités. Il nous faut alors une méthode qui reprenne l'idée de moyenner des $E_{\rm true}$ en enlevant les contraintes et biais provenants des bins.

\begin{figure}[!h]
\begin{center}
\includegraphics[width=\textwidth]{images/pictures/testCalibrationLego/CalibrationLego_ecalib_over_etrue.png}
\caption{À gauche : en bleu la distribution en fonction des $E_{\rm true}$ des $E_{\rm calib}/E_{\rm true}$ pour les particules n'interagissant pas avec le ECAL, chaque point de la courbe verte correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches de l'abscisse correspondante. À droite : idem pour les particules qui interagissent avec le ECAL et le HCAL. Nous voyons clairement l'apparition d'une structure, liée au caractère biné de la méthode.}
\label{ecaliboveretrueCL}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=\textwidth]{images/pictures/testCalibrationLego/CalibrationLego_ecalib_over_etrue_functionof_ecal_hcal.png}
\caption{À gauche : en bleu $E_{\rm calib}/E_{\rm true}$ en fonction de $E_{\rm hcal}$ pour les particules n'interagissant pas avec le ECAL, chaque point de la courbe verte correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches de l'abscisse correspondante.
À droite : chaque pixel correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches des coordonnées du pixel pour les particules qui interagissent avec le ECAL et le HCAL.}
\label{ecaliboveretrueCL_etrue}
\end{center}
\end{figure}

\section{Méthodes des plus proches voisins}
\label{KNN}
\subsection{Moyenne pondérée}
Nous utilisons encore des données simulées pour effectuer la calibration : chaque particule simulée $i$ est vue comme un point d'un espace tridimensionnel possédant des coordonnées $(E_{\rm ecal}^i, E_{\rm hcal}^i,E_{\rm true}^i)$.
Pour trouver l'énergie calibrée d'un point de coordonnées $(E_{\rm ecal}^0, E_{\rm hcal}^0)$ :
\begin{itemize}
	\item on recherche ses $k$ plus proches voisins dans le plan $(E_{\rm ecal}, E_{\rm hcal})$ que nous notons $(E_{\rm ecal}^i, E_{\rm hcal}^i), i \in [|1,...,k|]$
	\item on effectue une moyenne pondérée des $E_{\rm true}^i$ de ces plus proches voisins ce qui nous donne $E_{\rm calib}^0$, l'énergie calibrée.
\end{itemize}

La moyenne pondérée va donc s'exprimer ainsi :
\begin{equation}
	 E_{\rm calib}^0 = \frac{\sum_{i=1}^k g(\vec{x}^i,\sigma) \times E_{\rm true}^i}{\sum_{i=1}^k g(\vec{x}^i,\sigma)}, \vec{x}^i = (E_{\rm ecal}^i - E_{\rm ecal}^0, E_{\rm hcal}^i-E_{\rm hcal}^0)
\end{equation}

Nous avons pris pour facteur de pondération $g$ la distribution gaussienne $g(\vec{x},\sigma) = \exp{-\frac{1}{2}\frac{|\vec{x}|^2}{\sigma^2}}$, pour donner plus d'importance aux plus proches des k plus proches voisins, avec un paramètre $\sigma$ à fixer.

Pour trouver les plus proches voisins, j'ai utilisé la librairie \textit{Scikit Learn} \cite{scikitKNN} qui a l'avantage de proposer différents algorithmes optimisés de recherche.

La Figure  \ref{neighbors} montre que l'on sélectionne les points à moyenner dans des cercles dont le rayon varie en fonction de la densité de points. Il y a un problème à bas $E_{\rm hcal}$ et haut $E_{\rm ecal}$ où la densité de points est faible. Dans le cas $E_{\rm ecal} = 0$, le nombre de voisin est grand pour lisser la courbe de calibration, et à faible $E_{\rm hcal}$.
\begin{figure}[!h]
	\begin{center}
		\includegraphics[width=0.9\textwidth]{images/pictures/testKNN/KNN_neighborhood.png}
		\caption{À gauche : les voisins sélectionnés pour quelques valeurs de $E_{\rm hcal}$ dans le cas $E_{\rm ecal} = 0$ ($n_{voisins} = 2000$).  \\
		À droite : idem pour le cas dans le cas $E_{\rm ecal} \neq 0$ ($n_{voisins} = 250$).}
		\label{neighbors}
		\end{center}
\end{figure}

La calibration est réalisée \cite{GitHubKNN} avec 2000 voisins dans le cas $E_{\rm ecal}=0$ et 250 voisins dans le cas $E_{\rm ecal}\neq0$. Pour la pondération, une largeur de 5 GeV est choisie pour la gaussienne. 

La Figure \ref{surfKNN} montre que la surface est beaucoup plus lisse qu'avec la méthode précédente, mais en regardant le cas particulier de $E_{\rm ecal} = 0$ sur la Figure \ref{KNNcalib}, nous constatons une fois de plus que à bas $E_{\rm hcal}$, la courbe de calibration ne passe pas par le coeur de la distribution. 

Cela est peut être dû à de rares cas dans lesquels des particules de haute énergie $(E_{\rm true})$ ne déposent pas ou peu leur énergie dans les calorimètres. Il faudra trouver un moyen de les écarter pour vérifier.
\begin{figure}[!h]
\begin{center}
	\includegraphics[width=0.5\textwidth]{images/pictures/testKNN/KNN_plot3D_surf.eps}
	\caption{Surface de calibration $E_{\rm calib}$  en fonction de $E_{\rm ecal}$ et $E_{\rm hcal}$.}
	\label{surfKNN}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=\textwidth]{images/pictures/testKNN/KNN_calibration.png}
\caption{En bleu : \'Energie vraie en fonction de l'énergie déposée dans le HCAL, pour l'échantillon de hadrons n'interagissant pas dans le ECAL. En vert : courbe de calibration $E_{\rm calib} = f(E_{\rm hcal})$. La figure de droite est un zoom proche de l'origine de la figure de gauche.}
\label{KNNcalib}
\end{center}
\end{figure}

On teste maintenant l'efficacité de la calibration sur un second jeu de données. La Figure \ref{ecaliboveretrueKNN_ecal_hcal} montre qu'en moyenne que l'énergie calibrée est une sur-évaluation de l'énergie vraie car en moyenne  $E_{\rm calib}/E_{\rm true} > 1$ (position de la courbe verte à gauche, prédominance du rouge à droite). 
Cependant, nous pouvons voir à droite de la Figure \ref{ecaliboveretrueKNN_ecal_hcal} que la calibration est correcte dans la majeure partie du plan $(E_{\rm ecal}, E_{\rm ecal})$, et que nous avons pris en compte les non-linéarités.

La Figure \ref{ecaliboveretrueKNN} montre également cette sur évaluation pour les particules dont l'énergie vraie est inférieure à \SIUnits{100}{\giga\electronvolt}.

\begin{figure}[!h]
\begin{center}
\includegraphics[width=\textwidth]{images/pictures/testKNN/KNN_ecalib_over_etrue_functionof_ecal_hcal.png}
\caption{À gauche : en bleu $E_{\rm calib}/E_{\rm true}$ en fonction de $E_{\rm hcal}$ pour les particules n'interagissant pas avec le ECAL, chaque point de la courbe verte correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches de l'abscisse correspondante.
À droite : chaque pixel correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches des coordonnées du pixel pour les particules qui interagissent avec le ECAL et le HCAL.}
\label{ecaliboveretrueKNN_ecal_hcal}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=\textwidth]{images/pictures/testKNN/KNN_ecalib_over_etrue.png}
\caption{À gauche : en bleu la distribution en fonction des $E_{\rm true}$ des $E_{\rm calib}/E_{\rm true}$ pour les particules n'interagissant pas avec le ECAL, chaque point de la courbe verte correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches de l'abscisse correspondante. À droite : idem pour les particules qui interagissent avec le ECAL et le HCAL.}
\label{ecaliboveretrueKNN}
\end{center}
\end{figure}

\newpage
\subsection{Nettoyage gaussien}
Cette méthode \cite{GitHubKNNGC} est une variation de la précédente. Elle se base sur la constatation que la distribution en énergie vraie $E_{\rm true}$ des paquets de plus proches voisins est une distribution gaussienne (\textit{cf.} Figure \ref{gaussianfit}). Nous allons donc effectuer un fit pour trouver les paramètres de la gaussienne en question et ne prendre en compte que les plus proches voisins dont l'énergie vraie est $\mu -c\sigma \leq E_{\rm true}^i \leq \mu + c\sigma$ (nous prenons par défaut $c = 2$), avec $\mu, \sigma$ la moyenne et l'écart type de la distribution gaussienne.\\
Principe de l'algorithme :
\begin{itemize}
	\item on considère des points $(E_{\rm ecal}^{0,j}, E_{\rm hcal}^{0,j})$ où nous allons évaluer l'énergie calibrée.
	\item pour chaque $(E_{\rm ecal}^{0,j}, E_{\rm hcal}^{0,j})$ :
	\begin{itemize}
		\item on recherche ses $k$ plus proches voisins dans le plan $(E_{\rm ecal}, E_{\rm hcal})$ que nous notons $(E_{\rm ecal}^l, E_{\rm hcal}^l), l \in [|1,...,k|]$
		\item on fit les $E_{\rm ecal}^l$ par une gaussienne ce qui donne $\sigma$ et $\mu$, l'écart type et la moyenne de la gaussienne
		\item on ne conserve que les voisins dont : $\mu -c\sigma \leq E_{\rm true}^l \leq \mu + c\sigma$
		\item on effectue une moyenne pondérée une moyenne pondérée de l'énergie vraie de ces plus proches voisins, ce qui nous donne $E_{\rm calib}^{0,j}$, l'énergie calibrée 
	\end{itemize}
\end{itemize}

	Pour obtenir une valeur d'énergie calibrée quelque soit $(E_{\rm ecal}, E_{\rm hcal})$, on effectue une interpolation des $(E_{\rm ecal}^{0,j}, E_{\rm hcal}^{0,j}, E_{\rm calib}^{0,j})$ donnés précédemment.
	
Le fit gaussien s'effectue grâce à la librairie \textit{Scipy} \cite{scipyFit}, le principe étant de trouver les paramètres $K, \mu, \sigma$ de la fonction gaussienne $g : (x,K, \mu, \sigma) \mapsto K\exp{-\frac{1}{2}\frac{(x-\mu)^2}{\sigma^2}}$qui minimisent 
\begin{equation}
\chi^2 = \sum_i \left(\frac{y_i - g(x_i,K, \mu, \sigma) }{\epsilon_i} \right)^2
\end{equation}
où $(x_i,y_i)$ sont les valeurs à fiter (ici les valeur de l'histogramme) par la fonction $g$ et $\epsilon^_i$ l'erreur sur $y_i$ (illustration Figure \ref{gaussianfit}). 

\begin{figure}[!h]
\begin{center}
	\includegraphics[width=0.35\textwidth]{images/pictures/testKNNGF/KNNGaussianFit_example_hist.eps}
	\caption{Exemple d'un fit gaussien pour un histogramme de valeurs de $E_{\rm true}$. En bleu : les valeurs de l'histogramme; en vert : la courbe de fit; en rouge : la moyenne de la gaussienne; en gris : moyenne arithmétique de la distribution des $E_{\rm true}.}
	\label{gaussianfit}
\end{center}
\end{figure}
Nous pouvons également considérer le $\chi^2$ réduit, $\chi^2/ndf$, avec $ndf$ le nombre degré de liberté, qui doit être le plus proche de 1 pour correspondre à un fit de bonne qualité.

Au vu du $\chi^2/ndf$ (Figure \ref{chi2}), nous pouvons en conclure que le fit est très bon pour $E_{\rm ecal} \neq 0$ car la distribution du $\chi^2/ndf$ est centrée en 1. Ce n'est pas le cas pour $E_{\rm ecal} = 0$ mais nous nous en contenterons pour l'instant.

\begin{figure}[!h]
\begin{center}
\includegraphics[width=0.65\textwidth]{images/pictures/testKNNGC/KNNGaussianCleaning_chi2_calib.eps}
\caption{En haut à gauche : $\chi^2$ obtenu pour chaque fit effectué dans le cas $E_{\rm ecal} \neq 0$.
En haut à droite : l'histogramme des $\chi^2$ correspondant.
En bas à gauche : $\chi^2$ obtenu pour chaque fit effectué dans le cas $E_{\rm ecal} = 0$.
En bas à droite : l'histogramme des $\chi^2$ correspondant.}
\label{chi2}
\end{center}
\end{figure}

Pour l'interpolation, j'ai également utilisé une fonction proposée par \textit{Scipy} \cite{scipyInterp}, qui nous laisse le choix entre une interpolation linéaire et une interpolation à splines cubiques.

Les résultats de l'interpolations sont présentés sur les Figures \ref{surfKNNGC} et \ref{calibrationKNNGC}.
Cette fois ci, dans le plan $E_{\rm ecal } = 0$ (\textit{cf.} Figure \ref{calibrationKNNGC}), la courbe de calibration passe par le coeur de la distribution à faible $E_{\rm hcal}$ grâce au nettoyage gaussien.

\begin{figure}[!h]
\begin{center}
	\includegraphics[width=0.4\textwidth]{images/pictures/testKNNGC/KNNGaussianCleaning_plot3D_surf.eps}
	\captionof{figure}{Surface de calibration $E_{\rm calib}$  en fonction de $E_{\rm ecal}$ et $E_{\rm hcal}$.}
	\label{surfKNNGC}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=0.8\textwidth]{images/pictures/testKNNGC/KNNGaussianCleaning_calibration.png}
\caption{En bleu : \'Energie vraie en fonction de l'énergie déposée dans le HCAL, pour l'échantillon de hadrons n'interagissant pas dans le ECAL. En vert : courbe de calibration $E_{\rm calib} = f(E_{\rm hcal})$. La figure de droite est un zoom proche de l'origine de la figure de gauche.}
\label{calibrationKNNGC}
\end{center}
\end{figure}

On teste maintenant l'efficacité de la calibration sur un second jeu de données. La Figure \ref{ecaliboveretrueKNNGC_ecal_hcal} montre que la calibration est correcte dans le plan $E_{\rm ecal} = 0$ car la courbe de moyenne est très proche de 1. De plus, la non prédominance d'une couleur sauf le blanc dans le colormap de la Figure \ref{ecaliboveretrueKNNGC_ecal_hcal} montre que la calibration est correcte dans le plan ($E_{\rm ecal} ,E_{\rm hcal} $) et que les non-linéarités sont prises en compte.

La Figure \ref{ecaliboveretrueKNNGC} nous montre que la calibration correcte pour les particules dont l'énergie vraie est comprise entre $20$ et $140 \giga\electronvolt$.

\begin{figure}[!h]
\begin{center}
\includegraphics[width=0.8\textwidth]{images/pictures/testKNNGC/KNNGaussianCleaning_ecalib_over_etrue_functionof_ecal_hcal.png}
\caption{À gauche : en bleu $E_{\rm calib}/E_{\rm true}$ en fonction de $E_{\rm hcal}$ pour les particules n'interagissant pas avec le ECAL, chaque point de la courbe verte correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches de l'abscisse correspondante.
À droite : chaque pixel correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches des coordonnées du pixel pour les particules qui interagissent avec le ECAL et le HCAL.}
\label{ecaliboveretrueKNNGC_ecal_hcal}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=0.8\textwidth]{images/pictures/testKNNGC/KNNGaussianCleaning_ecalib_over_etrue.png}
\caption{À gauche : en bleu la distribution en fonction des $E_{\rm true}$ des $E_{\rm calib}/E_{\rm true}$ pour les particules n'interagissant pas avec le ECAL, chaque point de la courbe verte correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches de l'abscisse correspondante. À droite : idem pour les particules qui interagissent avec le ECAL et le HCAL.}
\label{ecaliboveretrueKNNGC}
\end{center}
\end{figure}


\subsection{Fit gaussien}
Pour cette méthode \cite{GitHubKNNGF},  il s'agit du même principe que précédemment mais nous allons considérer que la valeur de $E_{\rm calib}$ est la moyenne de la gaussienne qui fit les $E_{\rm true}$. 
Principe de l'algorithme :
\begin{itemize}
	\item on considère des points $(E_{\rm ecal}^{0,j}, E_{\rm hcal}^{0,j})$ où nous allons évaluer l'énergie calibrée.
	\item pour chaque $(E_{\rm ecal}^{0,j}, E_{\rm hcal}^{0,j})$ :
	\begin{itemize}
		\item on recherche ses $k$ plus proches voisins dans le plan $(E_{\rm ecal}, E_{\rm hcal})$ notés $(E_{\rm ecal}^i, E_{\rm hcal}^i), i \in [|1,...,k|]$
		on fit les $E_{\rm ecal}^i$ par une gaussienne ce qui donne $\sigma$ et $\mu$, l'écart type et la moyenne de la gaussienne
		\item On considère $E_{\rm calib}^{0,j} = \mu$
	\end{itemize}
\end{itemize}

Pour obtenir une valeur d'énergie calibrée quelque soit $(E_{\rm ecal}, E_{\rm hcal})$, on effectue une interpolation des $(E_{\rm ecal}^{0,j}, E_{\rm hcal}^{0,j}, E_{\rm calib}^{0,j})$ donnés précédemment.

\noindent
\begin{minipage}{0.5\linewidth}
Les résultats de l'interpolations sont présentés sur les Figures \ref{surfKNNGF} et \ref{calibrationKNNGF}.
Nous obtenons des surfaces et courbes de calibration assez similaires à celles présentées dans la section précédente, notamment la courbe de calibration passe bien par le coeur de la distribution.
\end{minipage}
\begin{minipage}{0.5\linewidth}
	\centering
	\includegraphics[width=0.7\textwidth]{images/pictures/testKNNGF/KNNGaussianFit_plot3D_surf.eps}
	\captionof{figure}{Surface de calibration $E_{\rm calib}$  en fonction de $E_{\rm ecal}$ et $E_{\rm hcal}$.}
	\label{surfKNNGF}
\end{minipage}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=0.8\textwidth]{images/pictures/testKNNGF/KNNGaussianFit_calibration.png}
\caption{En bleu : \'Energie vraie en fonction de l'énergie déposée dans le HCAL, pour l'échantillon de hadrons n'interagissant pas dans le ECAL. En vert : courbe de calibration $E_{\rm calib} = f(E_{\rm hcal})$. La figure de droite est un zoom proche de l'origine de la figure de gauche.}
\label{calibrationKNNGF}
\end{center}
\end{figure}

On teste maintenant l'efficacité de la calibration sur un second jeu de données et nous obtenons des résultats similaires à la section précédente. La Figure \ref{ecaliboveretrueKNNGF_ecal_hcal} montre que la calibration est correcte dans le plan $E_{\rm ecal} = 0$ car la courbe de moyenne est très proche de 1. De plus, la non prédominance d'une couleur sauf le blanc dans le colormap de la Figure \ref{ecaliboveretrueKNNGF_ecal_hcal} montre que la calibration est correcte dans le plan ($E_{\rm ecal} ,E_{\rm hcal} $) et que les non-linéarités sont prises en compte.

La Figure \ref{ecaliboveretrueKNNGF} nous montre que la calibration est correcte pour les particules dont l'énergie vraie est comprise entre $20$ et $140 \giga\electronvolt$.

\begin{figure}[!h]
\begin{center}
\includegraphics[width=\textwidth]{images/pictures/testKNNGF/KNNGaussianFit_ecalib_over_etrue.png}
\caption{À gauche : en bleu la distribution en fonction des $E_{\rm true}$ des $E_{\rm calib}/E_{\rm true}$ pour les particules n'interagissant pas avec le ECAL, chaque point de la courbe verte correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches de l'abscisse correspondante. À droite : idem pour les particules qui interagissent avec le ECAL et le HCAL.}
\label{ecaliboveretrueKNNGF}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=\textwidth]{images/pictures/testKNNGF/KNNGaussianFit_ecalib_over_etrue_functionof_ecal_hcal.png}
\caption{À gauche : en bleu $E_{\rm calib}/E_{\rm true}$ en fonction de $E_{\rm hcal}$ pour les particules n'interagissant pas avec le ECAL, chaque point de la courbe verte correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches de l'abscisse correspondante.
À droite : chaque pixel correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches des coordonnées du pixel pour les particules qui interagissent avec le ECAL et le HCAL.}
\label{ecaliboveretrueKNNGF_ecal_hcal}
\end{center}
\end{figure}
 
Cette méthode de calibration semble aussi bonne que la précédente tout en étant plus simple (moins de paramètres, moins de calculs, plus rapide). Il est donc temps de comparer plus précisément toutes les méthodes proposées. 

\newpage
\section{Comparaison et résultats}
\label{comparaison}

La Figure \ref{comparaison1} montre la $E_{\rm calib}/E_{\rm true}$ obtenue par fit gaussien en fonction de $E_{\rm hcal}$ pour $E_{\rm ecal} = 0$ et pour toutes les méthodes de calibration. Les deux dernières méthodes basées sur une recherche de plus proches voisins sont les plus adaptées car elles donnent une énergie calibrée proche de la valeur réelle quelque soit la valeur de $E_{\rm hcal}$. Il est à noter que pour que pour des dépôts de basse énergie dans le HCAL $(< \SIUnits{10}{\giga\electronvolt}$), l'énergie calibrée est en moyenne trop faible pour ces deux méthodes. Par la suite, il faudra trouver un moyen de corriger cela.

\begin{figure}[!h]
\centering
\includegraphics[width=\textwidth]{images/pictures/comparisons/comparison1.eps}
\caption{Moyenne de $E_{\rm calib}/E_{\rm true}$ obtenue par un fit gaussien en fonction de $E_{\rm hcal}$ pour les particules n'interagissant pas dans le ECAL.}
\label{comparaison1}
\end{figure}

La Figure \ref{comparaison2} montre la moyenne de $E_{\rm calib}/E_{\rm true}$ en fonction de $(E_{\rm ecal},E_{\rm hcal})$ pour toutes les méthodes de calibration. Les méthodes des plus proches voisins avec le nettoyage gaussien et le fit gaussien sont les plus adaptées car elles donnent une énergie calibrée proche de la valeur réelle quelque soit $(E_{\rm ecal},E_{\rm hcal})$. 

\begin{figure}
\begin{flushright}
\begin{subfigure}{0.45\textwidth}
\includegraphics[width=\textwidth]{images/pictures/comparisons/ecaliboveretrue_LinearRegression.png}
\caption{Régression linéaire}
\end{subfigure}
\begin{subfigure}{0.45\textwidth}
\includegraphics[width=\textwidth]{images/pictures/comparisons/ecaliboveretrue_CalibrationLego.png}
\caption{Méthode non paramétrique binée}
\end{subfigure}
\begin{subfigure}{0.45\textwidth}
\includegraphics[width=\textwidth]{images/pictures/comparisons/ecaliboveretrue_KNN.png}
\caption{Plus proches voisins}
\end{subfigure}
\begin{subfigure}{0.45\textwidth}
\includegraphics[width=\textwidth]{images/pictures/comparisons/ecaliboveretrue_KNNGaussianCleaning.png}
\caption{Plus proches voisins - Nettoyage gaussien}
\end{subfigure}
\begin{subfigure}{0.45\textwidth}
\includegraphics[width=\textwidth]{images/pictures/comparisons/ecaliboveretrue_KNNGaussianFit.png}
\caption{Plus proches voisins - Fit gaussien}
\end{subfigure}
\end{flushright}
\caption{Chaque pixel correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches des coordonnées du pixel pour les particules qui interagissent avec le ECAL et le HCAL.}
\label{comparaison2}
\end{figure}

La Figure \ref{comparaison3} présente les résultats en fonction de $E_{\rm true}$, dans les cas $E_{\rm ecal} = 0$ et $E_{\rm ecal} \neq 0$. 
Pour une valeur de $E_{\rm true}$ donnée, la distribution de $E_{\rm calib}/E_{\rm true}$ est ajustée par une gaussienne. La réponse de la calibration, définie comme la moyenne de la gaussienne, est montrée sur la partie haute. La résolution, définie comme la largeur de la gaussienne, est montrée sur la partie basse. Ces figures illustrent encore que les deux dernières méthodes sont les meilleures et permettent une bonne calibration pour des particules d'énergie vraie $E_{\rm true}$ comprises entre $10$ et $\SIUnits{120}{\giga\electronvolt}$ dans le premier cas et entre $20$ et $\SIUnits{140}{\giga\electronvolt}$ dans le second. Il est à remarquer que l'on n'observe pas d'amélioration de la résolution quand on change de méthode de calibration, ce qui paraît surprenant, car on a une meilleure uniformité de la réponse en fonction de $E_{\rm ecal}$ et $E_{\rm hcal}$. 

\begin{figure}[!h]
\centering
\includegraphics[width=\textwidth]{images/pictures/comparisons/comparison2.eps}
\caption{En haut à gauche : $E_{\rm calib}/E_{\rm true}$ moyens en fonction de $E_{\rm true}$ dans les cas $E_{\rm ecal} = 0$, chaque point d'une courbe correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches de l'abscisse correspondante.
En bas à gauche : $\sigma$ du fit gaussien correspondant.
En haut à droite : $E_{\rm calib}/E_{\rm true}$ moyens en fonction de $E_{\rm true}$ dans les cas $E_{\rm ecal} \neq 0$, chaque point d'une courbe correspond à la moyenne d'un fit gaussien de points $E_{\rm calib}/E_{\rm true}$ proches de l'abscisse correspondante.
En bas à droite : $\sigma$ du fit gaussien correspondant.}
\label{comparaison3}
\end{figure}


\newpage
\section{Conclusion}
Les méthodes des plus proches voisins avec un nettoyage gaussien ou avec un fit gaussien permettent de calibrer l'énergie des particules pour estimer correctement l'énergie vraie des particules en fonction de leur dépôts d'énergie dans les calorimètres ECAL et HCAL. 

Comparées à la régression linéaire, les méthodes proposées sont plus avantageuses car elles prennent en compte ce qui se passe localement et ne cherchent pas à donner une fonction générale pour déterminer $E_{\rm calib}$ en fonction de $E_{\rm ecal}$ et $E_{\rm hcal}$ et on constate qu'elles fournissent des énergies de calibrations plus proches de la réalité comparées à la régression linéaire. 
Cependant, ces méthodes restent à améliorer, notamment en ce qui concerne la calibration pour les particules de faible énergie. 

\'Egalement, d'autres points seront seront à développer par la suite. En effet, il faudrait être capable d'extrapoler une énergie de calibration pour des particules de plus hautes énergies. De plus il faudrait prendre en compte plus d'informations comme par exemple l'angle de la trajectoire des particules. Et enfin, il faudrait comparer avec la calibration utilisée actuellement par CMS pour le particle flow qui se base sur une fonction paramétrée \cite{PF}.

\small
\textit{
Tous les codes développés durant le stage sont consultables sur la plateforme Github :\\
\href{https://sniang.github.io/particle\_flow\_calibration/}{https://sniang.github.io/particle\_flow\_calibration}.
}
\newpage
\bibliographystyle{unsrt}
\bibliography{biblio} % mon fichier de base de données s'appelle biblio.bib

\end{document}

